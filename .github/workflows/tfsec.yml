name: Terraform Security Scan (tfsec)

on:
  push:
    branches:
      - '**' 
    paths:
      - '**.tf' 
      - '**.tfvars'

jobs:
  tfsec-security-scan:
    name: Scan Terraform Code with tfsec
    runs-on: ubuntu-latest
    permissions:
      actions:         read
      contents:        read 
      security-events: write 

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup tfsec
        run: |
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
          tfsec --version
      - name: Run tfsec Security Scan
        uses: aquasecurity/tfsec-sarif-action@v0.1.4
        with:
          sarif_file: tfsec.sarif
          soft_fail:  true 
      - name: Print tfsec Results to Logs
        run: |
          tfsec . --format lovely --no-color || true
      - name: Upload SARIF Report to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()   # Upload results even if tfsec finds issues
        with:
          sarif_file:     tfsec.sarif
          category:       tfsec
      - name: Save SARIF Report as Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name:            tfsec-sarif-report
          path:            tfsec.sarif
          retention-days: 30 